# Stop Midnight コア体験フロー案

最終更新: 2025-09-25 by kirara

## 目的
- 夜の衝動的な行動を抑制し、理性的に決めたプランを実行しやすくする。
- 22時前後の「今夜の予定」決定と、翌4時の「実績振り返り」を中心としたワークフローを確立する。
- 過去ログや連続達成表示でモチベーションを維持し、反復利用を促す。

## 想定ユーザーフロー

### 1. 初期設定 (Onboarding)
1. **呼び名を入力**: 「あなたのお名前、なんて呼べばいい？」→ `displayName` を取得（例: ○○さん / ○○ちゃん）。
2. **やめたいことを決める**: 「何をやめちゃいますか？」で A を選択（プリセット＋カスタム入力対応）。
3. **ヒアリング内容を設定**: 「A をやめるために、毎晩何を聞かれると良い？」→ デフォルトは「今夜のやること」。
4. **プラン通知時刻を選ぶ**: 「今夜のやることは何時に聞きましょうか？」→ デフォルト「毎日22時」。ランダム枠の設定もここで指定。
5. **振り返り時刻を決める**: 「振り返りは毎日何時に聞きましょうか？」→ デフォルト「翌4時」。
6. **完了メッセージ**: 「完了です！ 設定からいつでも変更できます」。同時に通知許可リクエスト（Web Push＋FCM登録）とパスコードロックの有無を確認。

### 2. 夜のプランニング (当日フロー)
- 通知テンプレ例（`displayName` を差し込み、ランダムに出し分け）
  - 「{name}さん！今日のやることを聞かせて下さい！」
  - 「{name}！とりあえず、今日のやることをここに書く。それから夜を過ごそう」
  - 「{name}ちゃん、今日のやることはもう決まってる？ゆっくり考えよう」
- 通知タップ or PWA起動で「TODAY」タブが開き、当日であれば通知前でも入力可能。

#### TODAYタブ（Planner状態）
- **ヘッダー**: 「{name}さん、こんばんは！」＋日付＋連続達成数＋やめたい習慣バッジ。
- **推奨カード**: 過去の成功パターンや最近やっていない活動をレコメンド。
- **プラン入力**:
  - プランラベル（例: 今夜のやること）とテキスト入力欄。
  - プリセット行動チップ（例: 読書 / ストレッチ / 明日の準備）。
  - ユーザー自身が候補を追加し、次回以降チップとして再利用できる入力。
- **確認セクション**:
  - 今夜のゴール要約を自動生成。
  - 翌朝リマインドON/OFF（デフォルトON）。
  - 「確定」ボタンで当日ログに予定を保存、レビュー待ち状態へ。

### 3. 夜の実績記録 (翌朝)
- 通知テンプレ例（`displayName` を差し込み、ランダムに出し分け）
  - 「{name}さん、{date}の夜は結局どうしてたの？」
  - 「{name}！{date}の夜はどんなだったか教えて！」
  - 「{name}ちゃん、今夜はどうお過ごしだったかな！聞かせて聞かせて〜！」
  ※表示日は「9/24の夜（＝ログ上は9/25）」のように補足。
- 通知タップでTODAYタブがレビュー状態に切り替わる。未入力であれば即レビュー。

#### TODAYタブ（Review状態）
- **上部**: 前夜の計画内容を表示（長文でも崩れないよう折り返し）。
- **自己評価**: ◎ / ○ / △ / ✕ の4択＋自由メモ。
- **実績タグ**:
  - やめたい習慣を避けられたかのチェック。
  - 代替行動を実施できたかのチェック。
- **保存**: ストリーク更新→モチベーションメッセージ表示。保存後は当日のPlanner状態に戻る。

### 4. モチベーション通知 (21:00)
- 通知文例: 「あと少しでプラン決めタイム！現在◯日連続で目標継続中」
- プッシュからPlanner画面へショートカット。

### 5. 振り返りビュー

#### カレンダー / タイムライン
- 月表示カレンダー
  - 各日にステータスアイコン（◎/○/△/✕）を表示。
  - セルには気分メーターも表示し、タップすると詳細モーダル（連続達成◯日や計画/実績・気分・保存日時）を表示し、再編集/削除が可能。
- タイムライン（リスト）
  - 日付順にカードを表示。
  - カード内に「予定」「実績」「気分」「回避した誘惑」等をまとめる。

#### 連続達成 & ゲーミフィケーション
- 避けたい習慣ごとの連続回避日数。
- 連続達成に応じた称号/ステッカーを表示し、Calendarモーダルにも反映。
- 連続が途切れた場合も「リカバリー」を促す演出を検討。

### 6. パスコードロック
- PWA起動時 or アクティブ再開時にPIN入力画面（オプション）。
- 生体認証（WebAuthn）対応は追加検討。

### 7. 画面構成（タブバー）
- Calendarモーダルから PLAN/REVIEW 編集・削除が可能（タスク0020実装済み）。
- **TODAY**: 当日のPlanner/Reviewが集約。通知を踏むとここが開き、未入力状態に応じてPlannerまたはReview UIを表示。
- **Calendar**: カレンダービュー。各日に◎/○/△/✕の評価バッジを表示し、タップでポップアップ（計画とレビュー詳細）。
- **Setting**: 名前ややめたい習慣、通知時刻、パスコードロックなど初期設定項目を変更できる画面。
- 下部タブバーはネイティブアプリ風のアイコン＋ラベル構成。

### 8. ゲーミフィケーションの方向性
- カテゴリ別の称号: 連続達成系（"月光ランナー"など）、回避回数系、リカバリー系を定義し、条件と報酬を明記
- 進捗バーや『次の称号まであと◯日／◯回』のメッセージを表示し、達成への道筋を見せる
- CalendarモーダルやToday画面のステータスピルに称号/進捗を反映し、再編集時にも最新情報を確認できる
- 連続達成が途切れた場合もリカバリー称号や再スタートバッジでモチベーションを維持

## 情報構造（データモデル草案）
```
UserSettings
  - uid (プロトでは固定)
  - displayName
  - avoidanceGoals: [goalId, label, type]
  - plannerPromptLabel (例: 今夜のやること)
  - plannerPromptTimeslot: { start: 22:00, end: 23:00, randomize: true }
  - reviewPromptTime: 04:00
  - motivationReminder: { time: 21:00, enabled: true }
  - promptTemplates: { planner: [...], review: [...] }
  - security: { passcodeEnabled: true }

NightPlan (per date)
  - date
  - createdAt
  - planText
  - suggestedActions: []
  - customSuggestions: []
  - avoidanceTargets: []
  - reviewDueAt

NightReview (per date)
  - date
  - rating (◎/○/△/✕)
  - actualText
  - avoidedGoals: []
  - moodScore
  - reviewTimestamp
```

## 画面ラフ（文字ベース）
```
[Planner]
┌────────────────────────────┐
│ ○○さん！今日のやることを聞かせて下さい！ │
├────────────────────────────┤
│ 9/25 (Thu)  連続達成 3日                   │
│ 避けたい: 夜食 / 深酒                      │
├────────────────────────────┤
│ 推奨:「先週は読書が続いています」          │
│ [読書カード][ストレッチカード] ...         │
├────────────────────────────┤
│ 今夜は何をする？                           │
│ [ テキスト入力欄                     ]      │
│ [ プリセットチップ群 + 追加欄       ]      │
├────────────────────────────┤
│ 翌4時に振り返りリマインド → ON           │
│ [確定する]                                 │
└────────────────────────────┘

[Review]
┌────────────────────────────┐
│ ○○ちゃん、今夜はどうお過ごしだったかな？ │
├────────────────────────────┤
│ 対象夜: 9/24 (ログ上は 9/25)              │
│ 予定: 読書 30分                           │
│ 避けたい: 夜食 / 深酒                     │
├────────────────────────────┤
│ 結果は？ ◎ ○ △ ✕                        │
│ コメント: [入力欄]                        │
├────────────────────────────┤
│ 避けたい行動                               │
│ [☑ 夜食を避けた] [☑ 深酒も回避]           │
│ 気分: ★★★★☆                             │
├────────────────────────────┤
│ [保存]                                    │
└────────────────────────────┘
```

## 未確定事項・次ステップ
- 連続達成判定のロジック（例: レビューが◎/○で「避けたい行動回避」が全チェック済みの場合にストリーク加算）。
- Plannerで複数プランを登録できるか、1日1つに限定するか。
- レコメンドロジックの詳細（単純頻度か、時間帯/気分との相関を見るか）。
- UIモックをFigma等で作成するか検討。
- フィードバック通知をスヌーズ可能にするか。
```

